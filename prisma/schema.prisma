// Prisma schema for Ateres Kallah - Spin to Win

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Prize model - stores all available prizes with inventory
model Prize {
  id                String   @id @default(cuid())
  title             String   // Short title shown on the wheel
  description       String   // Full description shown when won
  imageUrl          String?
  quantityTotal     Int      // Total prizes available
  quantityRemaining Int      // Remaining prizes (decremented on win)
  weight            Int      // Weight for probability (higher = more likely)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relation to winners
  winners           Winner[]
  
  @@index([quantityRemaining]) // Index for fast filtering of available prizes
}

// SpinCode model - one-time use codes
model SpinCode {
  id        String    @id @default(cuid())
  code      String    @unique // The actual code (e.g., "AK-2024-XXXX")
  name      String?   // Name associated with this code
  email     String?   // Email address associated with this code
  isUsed    Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  
  // Relation to winner (if code was used)
  winner    Winner?
  
  @@index([code, isUsed]) // Composite index for fast code validation
  @@index([email]) // Index for searching codes by email
  @@index([name]) // Index for searching codes by name
}

// Winner model - tracks all wins
model Winner {
  id        String   @id @default(cuid())
  codeId    String   @unique // One code = one winner
  prizeId   String
  wonAt     DateTime @default(now())
  prizeSent Boolean  @default(false) // Track if prize has been sent
  notes     String?  // Optional notes about prize fulfillment
  
  // Relations
  code      SpinCode @relation(fields: [codeId], references: [id])
  prize     Prize    @relation(fields: [prizeId], references: [id])
  
  @@index([wonAt]) // Index for sorting by date in admin panel
}

// RateLimit model - tracks failed code attempts to prevent brute force
model RateLimit {
  id         String   @id @default(cuid())
  identifier String   @unique // IP address or session identifier
  attempts   Int      @default(0)
  lastAttempt DateTime @default(now())
  
  @@index([identifier, lastAttempt])
}

// BottomContent model - stores what type of content to display at the bottom
model BottomContent {
  id          String   @id @default(cuid())
  displayType String   @default("NONE") // "NONE", "ADVERTISEMENT", or "SPONSOR_LOGOS"
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

// Advertisement model - stores banner advertisement
model Advertisement {
  id        String   @id @default(cuid())
  imageUrl  String   // Banner image URL
  linkUrl   String?  // Optional clickable URL
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// SponsorLogo model - stores sponsor logos for carousel
model SponsorLogo {
  id        String   @id @default(cuid())
  name      String   // Sponsor name
  logoUrl   String   // Logo image URL
  linkUrl   String?  // Optional clickable URL
  order     Int      @default(0) // Display order
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([order, isActive])
}

// EmailTemplate model - stores customizable email templates
model EmailTemplate {
  id          String   @id @default(cuid())
  type        String   @unique // "CODE_CREATED", "ADMIN_WIN_NOTIFICATION", "WINNER_CONFIRMATION"
  subject     String   // Email subject line with variables
  htmlBody    String   @db.Text // HTML email body with variables
  textBody    String?  @db.Text // Plain text version (optional)
  isActive    Boolean  @default(true) // Enable/disable template
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([type, isActive])
}

// VideoAccess model - whitelist of emails allowed to view videos
model VideoAccess {
  id        String      @id @default(cuid())
  email     String      @unique
  maxViews  Int         @default(3) // Can customize per email if needed
  createdAt DateTime    @default(now())
  
  // Relation to track actual views
  views     VideoView[]
  
  @@index([email])
}

// VideoView model - tracks individual video views per email
model VideoView {
  id       String      @id @default(cuid())
  email    String      // Email of viewer
  videoId  String      // e.g., "highlights-video"
  viewedAt DateTime    @default(now())
  
  // Relation to access record
  accessId String
  access   VideoAccess @relation(fields: [accessId], references: [id], onDelete: Cascade)
  
  @@index([email, videoId])
  @@index([accessId])
}
